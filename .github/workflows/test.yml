#=================================================
# Description: Build OpenWrt using GitHub Actions
# Lisence: GPL-3.0
# Author: lazymartin
#=================================================

name: Compile aria2 windows x86_64 Latest release

env:
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  TZ: Asia/Shanghai

on:
  schedule:
    - cron: '00 19 * * 0'
  push:
    paths: 
      - '.github/workflows/test.yml'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@master

    - name: Initialization environment
      env:
        DEBIAN_FRONTEND: noninteractive
        
      run: |
        sudo apt-get update
        sudo apt-get install -y make binutils autoconf automake autotools-dev libtool pkg-config git curl dpkg-dev gcc-mingw-w64 g++-mingw-w64 autopoint libcppunit-dev libxml2-dev libgcrypt20-dev lzip
        
    - name: Install dependences
      id: dependences
      run: |
        HOST=x86_64-w64-mingw32
        PREFIX=/usr/local/$HOST

        curl -L -O https://gmplib.org/download/gmp/gmp-6.1.2.tar.lz && \
        curl -L -O https://github.com/libexpat/libexpat/releases/download/R_2_2_7/expat-2.2.7.tar.bz2 && \
        curl -L -O https://www.sqlite.org/2019/sqlite-autoconf-3290000.tar.gz && \
        curl -L -O http://zlib.net/zlib-1.2.11.tar.gz && \
        curl -L -O https://c-ares.haxx.se/download/c-ares-1.15.0.tar.gz && \
        curl -L -O https://www.libssh2.org/download/libssh2-1.9.0.tar.gz

        tar xf gmp-6.1.2.tar.lz && \
        cd gmp-6.1.2 && \
        ./configure \
            --disable-shared \
            --enable-static \
            --prefix=/usr/local/$HOST \
            --host=$HOST \
            --disable-cxx \
            --enable-fat \
            CFLAGS="-mtune=generic -O2 -g0" && \
        sudo make -j$(nproc) install
        cd ..

        tar xf expat-2.2.7.tar.bz2 && \
        cd expat-2.2.7 && \
        ./configure \
            --disable-shared \
            --enable-static \
            --prefix=/usr/local/$HOST \
            --host=$HOST \
            --build=`dpkg-architecture -qDEB_BUILD_GNU_TYPE` && \
        sudo make -j$(nproc) install
        cd ..

        tar xf sqlite-autoconf-3290000.tar.gz && \
        cd sqlite-autoconf-3290000 && \
        ./configure \
            --disable-shared \
            --enable-static \
            --prefix=/usr/local/$HOST \
            --host=$HOST \
            --build=`dpkg-architecture -qDEB_BUILD_GNU_TYPE` && \
        sudo make -j$(nproc) install
        cd ..

        tar xf zlib-1.2.11.tar.gz && \
        cd zlib-1.2.11 && \
        CC=$HOST-gcc \
        AR=$HOST-ar \
        LD=$HOST-ld \
        RANLIB=$HOST-ranlib \
        STRIP=$HOST-strip \
        ./configure \
            --prefix=/usr/local/$HOST \
            --libdir=/usr/local/$HOST/lib \
            --includedir=/usr/local/$HOST/include \
            --static && \
        sudo make -j$(nproc) install
        cd ..

        tar xf c-ares-1.15.0.tar.gz && \
        cd c-ares-1.15.0 && \
        ./configure \
            --disable-shared \
            --enable-static \
            --without-random \
            --prefix=/usr/local/$HOST \
            --host=$HOST \
            --build=`dpkg-architecture -qDEB_BUILD_GNU_TYPE` \
            LIBS="-lws2_32" && \
        sudo make -j$(nproc) install
        cd ..

        tar xf libssh2-1.9.0.tar.gz && \
        cd libssh2-1.9.0 && \
        ./configure \
            --disable-shared \
            --enable-static \
            --prefix=/usr/local/$HOST \
            --host=$HOST \
            --build=`dpkg-architecture -qDEB_BUILD_GNU_TYPE` \
            --without-openssl \
            --with-wincng \
            LIBS="-lws2_32" && \
        sudo make -j$(nproc) install
        cd ..

        git clone https://github.com/aria2/aria2
        cd aria2 && autoreconf -i
        sed -i "s/HOST=i686-w64-mingw32/HOST=x86_64-w64-mingw32/g" ./mingw-config
        sed -i s"/\"1\"\, 1\, 16\, \'x\'/\"1\"\, 1\, 64\, \'x\'/g" ./src/OptionHandlerFactory.cc
        sed -i s"/1\, 16\,/1\, 64\,/g" ./src/OptionHandlerFactory.cc
        ./mingw-config
        sudo make -j$(nproc)
        sudo $HOST-strip src/aria2c.exe
        
    - name: Assemble Artifact
      run: |
        mkdir -p ./artifact
        cp /home/runner/work/scripts/scripts/aria2/src/aria2c.exe ./artifact/aria2c_windows_x86_64_64-threads.exe
        
    - name: Upload binaries to release
      uses: svenstaro/upload-release-action@v2
      with:
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        file: ./artifact/*
        tag: "Last_release"
        overwrite: true
        file_glob: true
